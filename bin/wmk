#!/bin/bash

# Assumes that this script is in bin/ inside the wmk repository and that the
# python virtual environment is in $wmk_home/venv

SCRIPT_PATH=$(realpath "$0")
SCRIPT_HOME=$(dirname "$SCRIPT_PATH")
WMK_HOME=$(dirname "$SCRIPT_HOME")
ACTION="$1"
BASEDIR="$2"
QUICK=""
SERVEPORT=""
SERVEIP=""
WMK_CONF="$BASEDIR/wmk_config.yaml"
CACHE_FILE="/tmp/wmk_render_cache.$(id -u).db"

. "$WMK_HOME/venv/bin/activate"

while [[ "$#" -gt 0 ]]; do
    case $1 in
        -p|--port)
            SERVEPORT="$2"
            shift; shift
            ;;
        -i|--ip)
            SERVEIP="$2"
            shift; shift
            ;;
        -q|--quick)
            QUICK=--quick
            shift
            ;;
        -f|--force)
            echo "NOTE: -f|--force is no longer needed. Switch ignored."
            shift
            ;;
        *)
            shift
            ;;
    esac
done

wmk_http_conf(){
    if test -s "$WMK_CONF"
    then
        python3 -c "import yaml;c=yaml.safe_load(open('$WMK_CONF'));print(c.get('http',{}).get('$1','$2'));"
    else
        echo "$2"
    fi
}

usage(){
    echo "wmk - a static site builder"
    echo "Usage:"
    echo "  wmk build|watch <dirname> [-q|--quick]"
    echo "  wmk serve <dirname> [-p|--port <portnum>] [-i|--ip <ip-addr>]"
    echo "  wmk watch-serve <dirname> [-p|--port <portnum>] [-i|--ip <ip-addr>]"
    echo "  wmk info|env|debug <dirname>"
    echo "  wmk clear-cache"
    echo "Action abbrevs: "
    echo "  b|r|run=build; w=watch; s=serve; ws=watch-serve; c=clear-cache"
    echo "See $WMK_HOME/readme.md for documentation"
}

clean_cache(){
    if [[ -e "$CACHE_FILE" ]]; then
        echo "Removing cache file ($CACHE_FILE)"
        rm -f "$CACHE_FILE"
    else
        echo "No cache file found"
    fi
}

watch_and_serve(){
    echo "$0 s '$BASEDIR' -p '$PORT' -i '$IP'"
    echo "$0 w '$BASEDIR'"
    (trap 'kill 0' SIGINT; "$0" s "$BASEDIR" -p "$PORT" -i "$IP" & "$0" w "$BASEDIR")
}

if test -d "$BASEDIR"
then
    case "$ACTION" in
        s|srv|serve)
            if [ "$SERVEIP" == "" ]; then
                IP=$(wmk_http_conf ip 127.0.0.1)
            else
                IP=$SERVEIP
            fi
            if [ "$SERVEPORT" == "" ]; then
                PORT=$(wmk_http_conf port 7007)
            else
                PORT=$SERVEPORT
            fi
            if [[ ! -e "$BASEDIR/wmk_config.yaml" ]]; then
                echo "WARNING: wmk_config.yaml not found!"
            fi
            if [[ ! -e "$BASEDIR/htdocs" ]]; then
                echo "WARNING: no $(realpath "$BASEDIR")/htdocs found!"
            fi
            python3 -m http.server "$PORT" --bind "$IP" --directory "$BASEDIR/htdocs"
            ;;
        r|b|run|build)
            "$WMK_HOME/wmk.py" "$BASEDIR" "$QUICK"
            ;;
        w|watch)
            cd "$BASEDIR" || exit 1
            while true; do
                inotifywait -e modify -e attrib -e close_write -e create -e delete -e delete_self -r .
                "$WMK_HOME/wmk.py" "$BASEDIR"
            done
            ;;
        ws|watch-serve)
            watch_and_serve
            ;;
        debug|env|info)
            echo "WMK ENVIRONMENT:"
            echo "  - wmk home: $WMK_HOME"
            if [[ -e "$BASEDIR/wmk_config.yaml" ]]; then
                echo "  - project directory: $(realpath "$BASEDIR")"
            else
                echo "  - WARNING: $(realpath "$BASEDIR") has no wmk_config.yaml!"
            fi
            if [[ -e "$CACHE_FILE" ]]; then
                echo "  - cache file: $CACHE_FILE"
            else
                echo "  - no cache file present"
            fi
            ;;
        c|cl|clean|clear|clean-cache|clear-cache)
            clean_cache
            ;;
        *)
            usage
            exit 1
            ;;
    esac
elif [[ "$ACTION" =~ ^(c|cl|clea[rn]|clea[rn]-cache)$ ]]; then
    clean_cache
else
    usage
    exit 1
fi
